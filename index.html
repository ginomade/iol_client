<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IOL Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <main class="max-w-5xl mx-auto p-6 space-y-6">
    <header class="flex items-center justify-between">
      <h1 class="text-2xl md:text-3xl font-bold">Portfolio InvertirOnline</h1>
      <span id="pais" class="text-sm text-gray-500"></span>
    </header>

    <!-- KPIs -->
    <section class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="bg-white p-4 rounded-xl shadow">
        <p class="text-sm text-gray-500">Total</p>
        <p id="kpiTotal" class="text-2xl font-semibold">$0</p>
      </div>
      <div class="bg-white p-4 rounded-xl shadow">
        <p class="text-sm text-gray-500">Disponible</p>
        <p id="kpiDisponible" class="text-2xl font-semibold">$0</p>
      </div>
      <div class="bg-white p-4 rounded-xl shadow">
        <p class="text-sm text-gray-500">Valorizado en Títulos</p>
        <p id="kpiValorizado" class="text-2xl font-semibold">$0</p>
      </div>
      <div class="bg-white p-4 rounded-xl shadow">
        <p class="text-sm text-gray-500">Comprometido</p>
        <p id="kpiComprometido" class="text-2xl font-semibold">$0</p>
      </div>
    </section>

    <!-- Charts -->
    <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-white p-4 rounded-xl shadow">
        <h2 class="font-semibold mb-2">Distribución por Activo</h2>
        <canvas id="pieActivos"></canvas>
      </div>
      <div class="bg-white p-4 rounded-xl shadow">
        <h2 class="font-semibold mb-2">Caja</h2>
        <canvas id="barCaja"></canvas>
      </div>
    </section>

    <!-- Tabla de activos -->
    <section class="bg-white p-4 rounded-xl shadow">
      <h2 class="font-semibold mb-3">Detalle de activos</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="text-left text-gray-500">
            <tr>
              <th class="py-2">Símbolo</th>
              <th class="py-2">Descripción</th>
              <th class="py-2">Cantidad</th>
              <th class="py-2">Último Precio</th>
              <th class="py-2">Valorizado</th>
            </tr>
          </thead>
          <tbody id="tablaActivos" class="divide-y"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    const fmt = (n) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', maximumFractionDigits: 2 }).format(Number(n||0));

    async function cargar() {
      try {
        const res = await fetch('/api/dashboard');
        if (!res.ok) throw new Error(await res.text());
        const { portfolio, estadoCuenta, totales, distribucion } = await res.json();

        // Encabezado
        document.getElementById('pais').textContent = `País portafolio: ${portfolio?.pais || '-'}`;

        // KPIs
        document.getElementById('kpiTotal').textContent = fmt(totales.total || estadoCuenta?.totalEnPesos || 0);
        document.getElementById('kpiDisponible').textContent = fmt(totales.disponible);
        document.getElementById('kpiValorizado').textContent = fmt(totales.titulosValorizados);
        document.getElementById('kpiComprometido').textContent = fmt(totales.comprometido);

        // Pie de activos (por valorizado)
        const pieLabels = distribucion.map(d => d.descripcion);
        const pieData = distribucion.map(d => d.valorizado || (d.cantidad * d.ultimoPrecio));
        new Chart(document.getElementById('pieActivos'), {
          type: 'pie',
          data: { labels: pieLabels, datasets: [{ data: pieData }] },
        });

        // Barra de caja (disponible vs comprometido)
        new Chart(document.getElementById('barCaja'), {
          type: 'bar',
          data: {
            labels: ['Disponible', 'Comprometido', 'Valorizado'],
            datasets: [{ data: [totales.disponible, totales.comprometido, totales.titulosValorizados] }]
          },
          options: {
            scales: { y: { beginAtZero: true } }
          }
        });

        // Tabla
        const tbody = document.getElementById('tablaActivos');
        tbody.innerHTML = '';
        distribucion.forEach(d => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="py-2 pr-4">${d.simbolo}</td>
            <td class="py-2 pr-4">${d.descripcion}</td>
            <td class="py-2 pr-4 text-right">${d.cantidad}</td>
            <td class="py-2 pr-4 text-right">${fmt(d.ultimoPrecio)}</td>
            <td class="py-2 pr-4 text-right">${fmt(d.valorizado || (d.cantidad * d.ultimoPrecio))}</td>
          `;
          tbody.appendChild(tr);
        });

      } catch (e) {
        console.error(e);
        alert('No se pudo cargar el dashboard. Ver consola para más detalles.');
      }
    }

    cargar();
  </script>
</body>
</html>
